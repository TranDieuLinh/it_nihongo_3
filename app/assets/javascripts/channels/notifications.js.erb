/**
 * Created by manhnd on 14/10/2017.
 */
App.notifications = App.cable.subscriptions.create("NotificationsChannel", {
    connected: function() {
        // Called when the subscription is ready for use on the server
    },

    disconnected: function() {
        // Called when the subscription has been terminated by the server
    },

    received: function(data) {
        // Called when there's incoming data on the websocket for this channel
        if(typeof data.message === 'undefined') data.message = "";

        $(".notifications .list-detail").html(data.list_notifications_html);
        this.checkCounter(data.counter);

        var notification = new Notification('', {
            icon: '<%= asset_path('icon-notification.png') %>',
            body: data.message
        });

        setTimeout(function() { notification.close() }, 5000);
        var that = this;
        if(typeof data.url !== 'undefined') {
            notification.onclick = function(){
                notification.close();
                event.preventDefault();
                data.counter -= 1;
                console.log(data.counter);
                that.checkCounter(data.counter);
                $.ajax({
                    data: {notification_id: data.notification_id},
                    type: 'POST',
                    url: '<%= Rails.application.routes.url_helpers.seen_notification_notifications_path%>',
                    dataType: 'json',
                    success: function() {
                        console.log("ok");
                    },
                    error: function(){
                        console.log("error")
                    }
                });
                window.location = data.url;
            }
        }
    },

    checkCounter: function(counter){
        $(".notifications .counter").html(counter);
        if(counter == 0) {
            $(".notifications .counter").css({'display': 'none'});
        } else {
            $(".notifications .counter").css({'display': 'block'});
        }
    }
});